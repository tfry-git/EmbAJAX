<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EmbAJAX: EmbAJAX</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">EmbAJAX
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">EmbAJAX </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Simplistic framework for creating and handling displays and controls on a web page served by an embeddable device (Arduino or other microcontroller with Arduino support).</p>
<h2>Overview</h2>
<p>In the Arduino world, it has become astonishingly easy to create a web server on a microprocessor. But at the same time there is a surprising lack of libraries to facilitate common tasks such as displaying some meter readings in textual or numeric displays, and keeping those up-to-date on the client, or providing basic HTML controls such as sliders, radio buttons, and pushbuttons to control the operation of the microprocessor.</p>
<p>While many, many projects are doing exactly this, each seems to have to implement the wheel anew. The goal of the present project is to provide a basic but extensible framework to take care of these common tasks, so that you can focus on the actual functionality.</p>
<p>I.e. the core features are:</p><ul>
<li>Ability to "print" common controls to an HTML page</li>
<li>Automatic addition of AJAX code to relay control information from the client to the server and back</li>
<li>Automatic handling of the AJAX requests on the server side</li>
<li>Object-based representation of the controls on the web page. The programmer can simply interact with local objects, while the framework takes care of keeping information in sync with the client.</li>
<li>Allows multiple clients to interact with the same page, concurrently.<ul>
<li>You can even pass information between two clients this way: Try loading the example, below, in two separate browsers!</li>
</ul>
</li>
<li>Supports arbitrary number of pages, and elements can be shared across pages.</li>
<li>Simple but effective error handling for unreliable connections and server reboots</li>
</ul>
<p>This framework <em>could</em> be used independently of the Arduino environment, but Arduino is the main target, thus the C++ implementation, and a focus on keeping things lean in memory.</p>
<h2>Status</h2>
<p>The library is still pretty new, but quite functional, and stabilizing. This means you can start using the library right now. However, please note, that there is <em>no</em> guarantee that upcoming versions of this library remain 100% compatible with the current version. I'll try not to break things <em>except</em> when there is a good reason to.</p>
<h3>Supported elements / features</h3>
<p>These controls / elements are supported as of now:</p>
<ul>
<li>Checkboxes</li>
<li>Radio buttons (mutually exclusive buttons)</li>
<li>Push buttons</li>
<li>Sliders</li>
<li>Text display</li>
<li>Text input</li>
<li>Drop down option select</li>
<li>RGB Color picker</li>
<li>Directional input ("joystick")</li>
<li>Static HTML blocks</li>
<li>Connection status indicator</li>
</ul>
<p>The following additional features may be of interest (supported as of now):</p>
<ul>
<li>Allows to insert your own custom CSS for styling (no styling in the lib).</li>
<li>Elements can be hidden, inputs can be disabled from the server (<a class="el" href="classEmbAJAXBase.html#ad433f1f7aa2386e2bd1c04a1fb79ca91">EmbAJAXBase::setVisible()</a>, setEnabled()).</li>
</ul>
<h3>Hardware support</h3>
<p>Currently there are output drivers for ESP8266 and ESP32. However, drivers are really easy to add. All that is needed is a very basic abstraction across some web server calls.</p>
<h4>ESP32 quirks and workaround</h4>
<p>Unfortunately, ESP32-support is currently plagued by a bug in the ESP32's networking code, that causes incoming connections to fail under some circumstances (<a href="https://github.com/espressif/arduino-esp32/issues/1921">https://github.com/espressif/arduino-esp32/issues/1921</a>). If you are using ESP32, and EmbAJAX feels sluggish, displays do not update, or the status indicator sometimes turns red, despite good network strength, you are probably being hit by this bug.</p>
<p>You can work around this by using the ESPAsyncWebServer library (<a href="https://github.com/me-no-dev/ESPAsyncWebServer">https://github.com/me-no-dev/ESPAsyncWebServer</a>). To do so, (after installing the lib), you will need to add:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;AsyncTCP.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;EmbAJAXOutputDriverESPAsync.h&gt;</span></div></div><!-- fragment --><p><b>above</b> <code>#include &lt;<a class="el" href="EmbAJAX_8h_source.html">EmbAJAX.h</a>&gt;</code> in your EmbAJAX sketches. No further adjustments are needed in the examples, provided, here.</p>
<h2>Example sketch</h2>
<p>Not really useful, but you know what to really do with a slider, and a display, right? Some further examples can be found in the examples folder.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;EmbAJAX.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// Set up web server, and register it with EmbAJAX. Note: EmbAJAXOutputDirverWebServerClass is a</span></div><div class="line"><span class="comment">// converience #define to allow using the same example code across platforms</span></div><div class="line">EmbAJAXOutputDriverWebServerClass server(80);</div><div class="line"><a class="code" href="classEmbAJAXOutputDriverESPAsync.html">EmbAJAXOutputDriver</a> driver(&amp;server);</div><div class="line"></div><div class="line"><span class="comment">// Define the main elements of interest as variables, so we can access them later in our sketch.</span></div><div class="line"><a class="code" href="classEmbAJAXSlider.html">EmbAJAXSlider</a> slider(<span class="stringliteral">&quot;slider&quot;</span>, 0, 500, 400);   <span class="comment">// slider, from 0 to 500, initial value 400</span></div><div class="line"><a class="code" href="classEmbAJAXMutableSpan.html">EmbAJAXMutableSpan</a> display(<span class="stringliteral">&quot;display&quot;</span>);         <span class="comment">// a plain text display</span></div><div class="line"></div><div class="line"><span class="comment">// Define a page (named &quot;page&quot;) with our elements of interest, above, interspersed by some uninteresting</span></div><div class="line"><span class="comment">// static HTML. Note: MAKE_EmbAJAXPage is just a convenience macro around the EmbAJAXPage&lt;&gt;-class.</span></div><div class="line">MAKE_EmbAJAXPage(page, <span class="stringliteral">&quot;EmbAJAXTest&quot;</span>, <span class="stringliteral">&quot;&quot;</span>,</div><div class="line">  <span class="keyword">new</span> <a class="code" href="classEmbAJAXStatic.html">EmbAJAXStatic</a>(<span class="stringliteral">&quot;&lt;h1&gt;This is a test&lt;/h1&gt;&lt;p&gt;The value you set in the following slider: &quot;</span>),</div><div class="line">  &amp;slider,</div><div class="line">  <span class="keyword">new</span> <a class="code" href="classEmbAJAXStatic.html">EmbAJAXStatic</a>(<span class="stringliteral">&quot; is sent to the server...&lt;/p&gt;&lt;p&gt;... which displays it here: &lt;b&gt;&quot;</span>),</div><div class="line">  &amp;display,</div><div class="line">  <span class="keyword">new</span> <a class="code" href="classEmbAJAXStatic.html">EmbAJAXStatic</a>(<span class="stringliteral">&quot;&lt;/b&gt;&lt;/p&gt;&quot;</span>)</div><div class="line">)</div><div class="line"></div><div class="line">void setup() {</div><div class="line">  <span class="comment">// Example WIFI setup as an access point. Change this to whatever suits you, best.</span></div><div class="line">  WiFi.mode(WIFI_AP);</div><div class="line">  WiFi.softAPConfig (IPAddress (192,168,4,1), IPAddress (0,0,0,0), IPAddress (255,255,255,0));</div><div class="line">  WiFi.softAP(<span class="stringliteral">&quot;EmbAJAXTest&quot;</span>, <span class="stringliteral">&quot;12345678&quot;</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Tell the server to serve our EmbAJAX test page on root</span></div><div class="line">  <span class="comment">// installPage() abstracts over the (trivial but not uniform) WebServer-specific instructions to do so</span></div><div class="line">  driver.installPage(&amp;page, <span class="stringliteral">&quot;/&quot;</span>, updateUI);</div><div class="line">  server.begin();</div><div class="line"></div><div class="line">  updateUI();  <span class="comment">// initialize display</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">char</span> buf[16];</div><div class="line"><span class="keywordtype">void</span> updateUI() {</div><div class="line">  <span class="comment">// And the following line is all that is needed to read the slider value, convert to a string, and send it</span></div><div class="line">  <span class="comment">// back to the client for display:</span></div><div class="line">  display.setValue(itoa(slider.intValue(), buf, 10));</div><div class="line"></div><div class="line">  <span class="comment">// NOTE: Instead of in this separate function, you could also place the above line in loop(). However, having</span></div><div class="line">  <span class="comment">// it here allows the library to send back the updated display, immediately, resulting in a snappier UI on</span></div><div class="line">  <span class="comment">// the client.</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> loop() {</div><div class="line">    <span class="comment">// handle network. loopHook() simply calls server.handleClient(), in most but not all server implementations.</span></div><div class="line">    driver.loopHook();</div><div class="line">}</div></div><!-- fragment --><h2>Installation</h2>
<p>For now the installation routine is:</p><ul>
<li>Download a ZIP of the current development version: <a href="https://github.com/tfry-git/EmbAJAX/archive/master.zip">https://github.com/tfry-git/EmbAJAX/archive/master.zip</a></li>
<li>In your Arduino-IDE, select Sketch-&gt;Include Library-&gt;Add .ZIP Library, then select the downloaded .zip for installation</li>
<li>You may need to restart your IDE for the library and its examples to show up</li>
</ul>
<h2>Further readings</h2>
<p>API documentation is at <a href="https://tfry-git.github.io/EmbAJAX/api/annotated.html">https://tfry-git.github.io/EmbAJAX/api/annotated.html</a> .</p>
<h2>A word on security</h2>
<p>At present, EmbAJAX does not incorporate any security mechanisms. Anybody who can connect to the server will be able to view and set any control. So any security will have to be implemented on the network level.</p>
<p>One easy way to do so, that will suit many simple use cases - and is used in the examples - is to simply set up your device as a WiFi access point, with encryption and password protection. With this, any client in range can connect, <em>if</em> they have the credentials for the access point.</p>
<p>If you need remote connections, currently your best bet will be to use an nginx proxy server (see e.g. <a href="https://jjssoftware.github.io/secure-your-esp8266/">https://jjssoftware.github.io/secure-your-esp8266/</a>).</p>
<p>Future versions of EmbAJAX will provide a basic authentication and permission system, but to provide any meaningful level of security, this will mean communication with your device will have to be encrypted. One exciting news in this regard is that an HTTPS server implementation is about to be added to the ESP8266 arduino core. So check back soon (or submit your pull request)!</p>
<h2>Some implementation notes</h2>
<p>Currently, the web servers for embeddables I have dealt with so far, are limited to one client at a time. Therefore, if using a permanent connection, all further access would be blocked. Even separate page loads from the same browser. So, instead, we resort to regular polling for updates. An update poll is always included, automatically, when the client sends control changes to the server, so in most cases, the client would still appear to be refreshed, immediately.</p>
<p>To avoid sending all states of all controls on each request from each client, the framework keeps track of the latest "revision number" sent to any client. The client pings back its current revision number on each request, so only real changes have to be forwarded.</p>
<p>Concurrent access by an arbitrary number of separate clients is the main reason behind going with AJAX, instead of WebSockets, even if the latter are often described as more "modern". Note that the purpoted drawback to AJAX - latency - can easily be circumventented for most use cases, as desribed, above. Still, it would be relatively easy to generalize the framework to also allow a WebSocket-connection. I'm not doing this, ATM, for fear of adding unneccessary complexity for little or no practical gain.</p>
<p>You may have noted that the framework avoids the use of the String class, even though that would make some things easier. The reason for this design choice is that the overhead of using char*, here, in a sketch that may be using String, already, is low. However, if this framework were to rely on String, while nothing else in the sketch uses String, that would incur a significant overhead. Further, it should be noted, that the risk of memory-fragmentation is relatively real in the present use-case, as arbitrary strings are regularly coming in "from the outside". Nonetheless, using Strings would relieve the use from having to worry about the lifetime of strings passed in to the framework, and thus, in the future, it may make sense to support String <em>optionally</em>.</p>
<p>Another thing you will notice is that the framework avoids any sort of dynamic list. Instead, template classes with a size parameter are used to keep lists of elements (such as the <a class="el" href="classEmbAJAXPage.html" title="The main interface class. ">EmbAJAXPage</a>&lt;SIZE&gt;). The reason is again, memory efficiency, and fear of fragmentation. Also, the vast majority of use cases should be perfectly fine with a statically defined setup of elements. However, should the need arise, it would be very easily possible to create a dynamically allocated analogon to EmbAJAXContainer&lt;SIZE&gt;. An instance of that could simply be inserted into a page, and serve as a straight-forward wrapper around elements that are created dynamically. (A different question is how to keep this in sync with the client, of course, if that is also a requirement...)</p>
<p>Connection error handling, despite asynchronous requests: Both server and client keep track of the "revision" number of their state. This is used for keeping several clients in sync, but also for error handling: If the server detects that it has a lower revision than the client, it will know that it has rebooted (while the client has not), and will re-send all current states. If the client tries to send a UI change, but the network request fails, it will discard its revision, and thereby ask the server to also re-send all states. Thus, the latest user input may get lost on a network error, but the state of the controls shown in the client will remain in sync with the state as known to the server.</p>
<h2>Some TODOs</h2>
<ul>
<li>More controls:<ul>
<li>One nice to have idea: A sort of "touch-screen", reporting clicks, and releases with exact position, continuous reporting of mouse position (optional: always, never, while button pressed).<ul>
<li>Bonus points: With position marker ("cursor"), with ability to load arbitrary background image.</li>
</ul>
</li>
<li>Toggle buttons (trivial to implement on top of pushbuttons)</li>
</ul>
</li>
<li>More drivers</li>
<li>More examples</li>
<li>Basic authentication / permission features<ul>
<li>Will need to rely on encrypted communication. I.e. HTTPS server implementation.</li>
</ul>
</li>
</ul>
<h2>The beggar's line</h2>
<p>So far everbody else has been rolling their own piece of AJAX for their own little project, and that's what I could have done, too, in a tiny fraction of the time spent on this framework, including its docs. But I chose to write all this, instead. Because I believe in re-usable solutions and shared efforts. If you do too, and this framework is useful to you, consider dropping a micro-donation via PayPal to <a href="#" onclick="location.href='mai'+'lto:'+'tho'+'ma'+'s.f'+'ri'+'edr'+'ic'+'hsm'+'ei'+'er@'+'gm'+'x.d'+'e'; return false;">thoma<span style="display: none;">.nosp@m.</span>s.fr<span style="display: none;">.nosp@m.</span>iedri<span style="display: none;">.nosp@m.</span>chsm<span style="display: none;">.nosp@m.</span>eier@<span style="display: none;">.nosp@m.</span>gmx.<span style="display: none;">.nosp@m.</span>de</a> . Thanks! </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
